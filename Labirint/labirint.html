<html>
<head>
    <meta charset="utf-8">
    <title>Labirint</title>

    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>

    <script src="./scripts/babylon.js"></script>
    <script src="./scripts/hand.js"></script>
    <script src="./scripts/cannon.js"></script>  <!-- optional physics engine -->
</head>

<body>
<canvas id="renderCanvas"></canvas>
<div id="gameOver" class="hidden">
    <div id="gameOverText">Game Over</div>
</div>
<script type="text/javascript">
    var stevecObjektov = 0;
    var hitrost= 0;
    var posastStrela=false;
    var sefeStrela=false;
    var tockaVklopa2;
    var kljuc;
    var kljuc2;
    var start;
    var izhod;
    var napis3;
    var pavza=false;
    var player;
    var posast1;
    var posast;
    var sefe;
    var treeM;
    var lab;
    var st = 0;
    var meja1;
    var meja2;
    var meja3;
    var meja4;
    var napis, napis2, napis3, napis4, napis5, napis6, napis7;
    var item1, item2, item3, item4, trapItem, itemFound, missingItems;
    var ljudek;
    var music, gr, sad, victory, gr2;
    var restart;

    if (BABYLON.Engine.isSupported()) {
        var canvas = document.getElementById("renderCanvas");
        var engine = new BABYLON.Engine(canvas, true);
        var obrnjenost = 4;
        var premikanjeX = 0;
        var premikanjeZ = 0;
        var labyrinth;
        var life1, life11, life2, life22, life3, life33, life4, life44, life5, life55;
        var stZadetkov = 5;
        var stZadetkovSefe = 10;
        var ubita = false;
        var sefeUbit = false;
        start = new BABYLON.Vector3(-34.697440739293484, -8, -31.73790774292142);
        var createScene = function () {
            var scene = new BABYLON.Scene(engine);
            scene.clearColor = new BABYLON.Color3(0, 1, 0);
            //var light = new BABYLON.PointLight("Omni", new BABYLON.Vector3(20, 20, 100), scene);
            var light0 = new BABYLON.HemisphericLight("Hemi0", new BABYLON.Vector3(0, 1, 0), scene);
            light0.diffuse = new BABYLON.Color3(0.00001, 0.00001, 0.00001);
            light0.specular = new BABYLON.Color3(0.1, 0.1, 0.1);
            light0.groundColor = new BABYLON.Color3(0.5, 0.5, 0.5);
            var light1 = new BABYLON.DirectionalLight("Dir0", new BABYLON.Vector3(0, -1, 0), scene);
            light1.diffuse = new BABYLON.Color3(0.8, 0.8, 0.8);
            light1.specular = new BABYLON.Color3(0, 0, 0);
            light1.groundColor = new BABYLON.Color3(1, 1, 1);
            light1.intensity = 1.8;
            var sphere = BABYLON.Mesh.CreateSphere("sphere", 30.0, 0.8, scene);
            sphere.position = start;
            sphere.wireFrame = true;
            sphere.rotation.y = Math.PI;

            var camera = new BABYLON.FollowCamera("FreeCamera", new BABYLON.Vector3(-34.697440739293484, -8, -40.73790774292142), scene);
            camera.target = sphere;
            camera.rotationOffset = 0;
            camera.radius = 4;
            camera.heightOffset = 2;
            camera.cameraAcceleration = 0.05;
            camera.maxCameraSpeed = 5;
            camera.parent = light1;

            //camera.attachControl(canvas, true);
            // 3d model
            BABYLON.SceneLoader.ImportMesh("", "assets/", "labyrinth.babylon", scene, function (newMeshes2) {
                labyrinth = new BABYLON.StandardMaterial("assets/", scene);
                labyrinth.diffuseTexture = new BABYLON.Texture("assets/stene.jpg", scene);
                labyrinth.diffuseTexture.uScale = 0.5;
                labyrinth.diffuseTexture.vScale = 0.5;

                for (var i = 0; i < newMeshes2.length; i++) {
                    newMeshes2[i].isVisible = true;
                    newMeshes2[i].checkCollisions = true;
                    newMeshes2[i].scaling = new BABYLON.Vector3(2, 1, 2);
                    newMeshes2[i].position = new BABYLON.Vector3(0, -10, 0);
                    newMeshes2[i].material = labyrinth;
                }
                lab = newMeshes2[0];
                lab.computeWorldMatrix(true);

            });
            /*scene.registerBeforeRender(function(){

            });*/
            sphere.isVisible=false;
            BABYLON.SceneLoader.ImportMesh("", "assets/", "player1.babylon", scene, function (newMeshes0) {
                player = new BABYLON.StandardMaterial("assets/", scene);
                player.diffuseTexture = new BABYLON.Texture("assets/player5.png", scene);
                player.diffuseTexture.uScale = 1;
                player.diffuseTexture.vScale = 1;

                for(var i = 0; i < newMeshes0.length; i++) {

                    //newMeshes0[i].checkCollisions = true;
                    newMeshes0[i].scaling = new BABYLON.Vector3(2, 2, 2);
                    //newMeshes0[i].position = start;
                    newMeshes0[i].position.x = start.x;
                    newMeshes0[i].position.y = -7.9;
                    newMeshes0[i].position.z = start.z;
                    newMeshes0[i].rotation.y = Math.PI/2;
                    //newMeshes0[i].parent = sphere;

                    newMeshes0[i].isVisible = true;
                    newMeshes0[i].material = player;
                }
                ljudek=newMeshes0[0];
                scene.registerBeforeRender(function(){
                    //newMeshes0[0].position = sphere.position;
                    newMeshes0[0].position.x = sphere.position.x;
                    newMeshes0[0].position.y = -7.9;
                    newMeshes0[0].position.z = sphere.position.z;
                    //newMeshes0[0].rotation = sphere.rotation;
                    //newMeshes0[0].rotation.y = Math.PI;
                });
            });
            BABYLON.SceneLoader.ImportMesh("", "assets/", "monster1.babylon", scene, function (newMeshes1) {
                posast1 = new BABYLON.StandardMaterial("assets/", scene);
                posast1.diffuseTexture = new BABYLON.Texture("assets/monsterlayer1.bmp", scene);
                posast1.diffuseTexture.uScale = 1;
                posast1.diffuseTexture.vScale = 1;

                for(var i = 0; i < newMeshes1.length; i++) {
                    newMeshes1[i].isVisible = true;
                    //newMeshes1[i].checkCollisions = true;
                    newMeshes1[i].scaling = new BABYLON.Vector3(1, 0.3, 1);
                    newMeshes1[i].position = new BABYLON.Vector3(30, -8, 2);
                    newMeshes1[i].material = posast1;
                }

                scene.registerBeforeRender(function () {
                    newMeshes1[0].position = posast.position;
                    if(ubita){
                        newMeshes1[0].dispose();
                    }
                });

            });
            BABYLON.SceneLoader.ImportMesh("", "assets/", "boss.babylon", scene, function (newMeshes2) {
                treeM = new BABYLON.StandardMaterial("assets/", scene);
                treeM.diffuseTexture = new BABYLON.Texture("assets/monsterlayer1.bmp", scene);
                treeM.diffuseTexture.uScale = 1;
                treeM.diffuseTexture.vScale = 1;

                for(var i = 0; i < newMeshes2.length; i++) {
                    newMeshes2[i].isVisible = true;
                    //newMeshes2[i].checkCollisions = true;
                    newMeshes2[i].scaling = new BABYLON.Vector3(0.1, 0.1, 0.1);
                    //newMeshes2[i].position = new BABYLON.Vector3(-34.697440739293484, -8, -38.73790774292142);
                    newMeshes2[i].material = treeM;
                    newMeshes2[i].rotation.y = -Math.PI/2;

                }

                scene.registerBeforeRender(function () {
                    newMeshes2[0].position = sefe.position;
                    if(sefeUbit){
                        newMeshes2[0].dispose();
                    }
                });
            });
            gr = new BABYLON.Sound("monster", "assets/monster.mp3", scene, function() {
                gr.play();
                gr.stop();
            });
            win = new BABYLON.Sound("win", "assets/victory.mp3", scene, function() {
                win.play();
                win.stop();
            });
            over = new BABYLON.Sound("monster", "assets/sad.mp3", scene, function() {
                over.play();
                over.stop();
            });
            var volume = 0.75;
            music = new BABYLON.Sound("creepy", "assets/music.mp3", scene, function() {

                music.stop();
            }, { loop: true, autoplay: true, volume: volume });
            gr2 = new BABYLON.Sound("monster", "assets/dies.mp3", scene, function() {
                gr2.play();
                gr2.stop();
            });
            BABYLON.SceneLoader.ImportMesh("", "assets/", "rolka5babylon.babylon", scene, function (newMeshes5) {
                var rolka = new BABYLON.StandardMaterial("assets/", scene);
                rolka.diffuseTexture = new BABYLON.Texture("assets/skejt.png", scene);
                rolka.diffuseTexture.uScale = 1;
                rolka.diffuseTexture.vScale = 1;

                for(var i = 0; i < newMeshes5.length; i++) {
                    newMeshes5[i].isVisible = true;
                    //newMeshes5[i].checkCollisions = true;
                    newMeshes5[i].scaling = new BABYLON.Vector3(0.8, 1, 0.8);
                    newMeshes5[i].position = new BABYLON.Vector3(-34.697440739293484, -9.98, -31.73790774292142);
                    newMeshes5[i].material = rolka;
                }

                scene.registerBeforeRender(function () {
                    //for(var i = 0; i < newMeshes5.length; i++) {
                        newMeshes5[0].position.x = sphere.position.x;
                        newMeshes5[0].position.y = -9.98;
                        newMeshes5[0].position.z = sphere.position.z;
                        newMeshes5[0].rotation = sphere.rotation;


                    //}
                });

            });

            //MEMORY BAR
            life1 = BABYLON.Mesh.CreatePlane("life1", 0.15, scene);
            life11 = new BABYLON.StandardMaterial("1", scene);
            life11.diffuseTexture = new BABYLON.Texture("assets/life1.jpg", scene);
            life1.material = life11;
            life1.rotation = new BABYLON.Vector3(0, 0, 0);
            life1.parent = camera;
            life1.position = new BABYLON.Vector3(2.47, 1.15, 3);
            life1.renderingGroupId = 1;
            life2 = BABYLON.Mesh.CreatePlane("life2", 0.15, scene);
            life22 = new BABYLON.StandardMaterial("1", scene);
            life22.diffuseTexture = new BABYLON.Texture("assets/life2.jpg", scene);
            life2.material = life22;
            life2.parent = camera;
            life2.position = new BABYLON.Vector3(2.3, 1.15, 3);
            life2.rotation = new BABYLON.Vector3(0, 0, 0);
            life2.renderingGroupId = 1;
            life3 = BABYLON.Mesh.CreatePlane("life3", 0.15, scene);
            life33 = new BABYLON.StandardMaterial("1", scene);
            life33.diffuseTexture = new BABYLON.Texture("assets/life3.jpg", scene);
            life3.material = life33;
            life3.parent = camera;
            life3.position = new BABYLON.Vector3(2.13, 1.15, 3);
            life3.rotation = new BABYLON.Vector3(0, 0, 0);
            life3.renderingGroupId = 1;
            life4 = BABYLON.Mesh.CreatePlane("life4", 0.15, scene);
            life44 = new BABYLON.StandardMaterial("1", scene);
            life44.diffuseTexture = new BABYLON.Texture("assets/life4.jpg", scene);
            life4.material = life44;
            life4.parent = camera;
            life4.position = new BABYLON.Vector3(1.96, 1.15, 3);
            life4.rotation = new BABYLON.Vector3(0, 0, 0);
            life4.renderingGroupId = 1;
            life5 = BABYLON.Mesh.CreatePlane("life5", 0.15, scene);
            life55 = new BABYLON.StandardMaterial("1", scene);
            life55.diffuseTexture = new BABYLON.Texture("assets/life5.jpg", scene);
            life5.material = life55;
            life5.parent = camera;
            life5.position = new BABYLON.Vector3(1.79, 1.15, 3);
            life5.rotation = new BABYLON.Vector3(0, 0, 0);
            life5.renderingGroupId = 1;
            life1.isVisible=false;
            life2.isVisible=false;
            life3.isVisible=false;
            life4.isVisible=false;
            life5.isVisible=false;

            napis = BABYLON.Mesh.CreatePlane("memorybar", 0.25, scene, false);
            var material1 = new BABYLON.StandardMaterial("membar", scene);
            material1.diffuseTexture = new BABYLON.Texture("assets/Memory.png", scene);
            napis.material = material1;
            napis.scaling.y = 0.55;
            napis.scaling.x = 2.3;
            napis.parent = camera;
            napis.position = new BABYLON.Vector3(1.40, 1.15, 3);
            napis.rotation = new BABYLON.Vector3(0, 0, 0);
            napis.isVisible = false;
            napis.renderingGroupId = 1;
            napis2 = BABYLON.Mesh.CreatePlane("memorybar", 0.25, scene, false);
            var material2 = new BABYLON.StandardMaterial("membar", scene);
            material2.diffuseTexture = new BABYLON.Texture("assets/0.png", scene);
            napis2.material = material2;
            napis2.scaling.y = 0.55;
            napis2.scaling.x = 4.5;
            napis2.parent = camera;
            napis2.position = new BABYLON.Vector3(-2, 1.15, 3);
            napis2.rotation = new BABYLON.Vector3(0, 0, 0);
            napis2.isVisible = false;
            napis2.renderingGroupId = 1;
            napis3 = BABYLON.Mesh.CreatePlane("bar", 1.2, scene, false);
            var material3 = new BABYLON.StandardMaterial("bar", scene);
            material3.diffuseTexture = new BABYLON.Texture("assets/gameover.png", scene);
            napis3.material = material3;
            napis3.scaling.x = 2.4;
            napis3.scaling.y = 1.6;
            napis3.parent = camera;
            napis3.position = new BABYLON.Vector3(0, 0.05, 3);
            napis3.rotation = new BABYLON.Vector3(0, 0, 0);
            napis3.isVisible = false;
            napis3.renderingGroupId = 1;
            napis4 = BABYLON.Mesh.CreatePlane("bar", 0.25, scene, false);
            var material4 = new BABYLON.StandardMaterial("bar", scene);
            material4.diffuseTexture = new BABYLON.Texture("assets/pause.png", scene);
            napis4.material = material4;
            napis4.scaling.x = 4.5;
            napis4.scaling.y = 0.55;
            napis4.parent = camera;
            napis4.position = new BABYLON.Vector3(1.98, -1.15, 3);
            napis4.rotation = new BABYLON.Vector3(0, 0, 0);
            napis4.isVisible = false;
            napis4.renderingGroupId = 1;
            napis5 = BABYLON.Mesh.CreatePlane("bar", 1.2, scene, false);
            var material5 = new BABYLON.StandardMaterial("bar", scene);
            material5.diffuseTexture = new BABYLON.Texture("assets/pause2.png", scene);
            napis5.material = material5;
            napis5.scaling.x = 2.4;
            napis5.scaling.y = 1;
            napis5.parent = camera;
            napis5.position = new BABYLON.Vector3(0, 0.05, 3);
            napis5.rotation = new BABYLON.Vector3(0, 0, 0);
            napis5.isVisible = false;
            napis5.renderingGroupId = 1;
            napis6 = BABYLON.Mesh.CreatePlane("bar", 2.6, scene, false);
            var material6 = new BABYLON.StandardMaterial("bar", scene);
            material6.diffuseTexture = new BABYLON.Texture("assets/start.png", scene);
            napis6.material = material6;
            napis6.scaling.x = 2.2;
            napis6.scaling.y = 1;
            napis6.parent = camera;
            napis6.position = new BABYLON.Vector3(0, 0, 3);
            napis6.rotation = new BABYLON.Vector3(0, 0, 0);
            napis6.isVisible = true;
            napis6.renderingGroupId = 1;
            napis7 = BABYLON.Mesh.CreatePlane("bar", 2.6, scene, false);
            var material7 = new BABYLON.StandardMaterial("bar", scene);
            material7.diffuseTexture = new BABYLON.Texture("assets/win.png", scene);
            napis7.material = material7;
            napis7.scaling.x = 2.2;
            napis7.scaling.y = 1;
            napis7.parent = camera;
            napis7.position = new BABYLON.Vector3(0, 0, 3);
            napis7.rotation = new BABYLON.Vector3(0, 0, 0);
            napis7.isVisible = false;
            napis7.renderingGroupId = 1;
            itemFound = BABYLON.Mesh.CreatePlane("itemFound", 1, scene, false);
            var itemFoundT = new BABYLON.StandardMaterial("itemFoundT", scene);
            itemFoundT.diffuseTexture = new BABYLON.Texture("assets/itemFound.png", scene);
            itemFound.material = itemFoundT;
            itemFound.scaling.x = 3.1;
            itemFound.scaling.y = 1;
            itemFound.parent = camera;
            itemFound.position = new BABYLON.Vector3(0, 0.05, 3);
            itemFound.rotation = new BABYLON.Vector3(0, 0, 0);
            itemFound.isVisible = false;
            itemFound.renderingGroupId = 1;
            missingItems = BABYLON.Mesh.CreatePlane("missingItems", 1, scene, false);
            var missingItemsT = new BABYLON.StandardMaterial("missingItemsT", scene);
            missingItemsT.diffuseTexture = new BABYLON.Texture("assets/missingItems.png", scene);
            missingItems.material = missingItemsT;
            missingItems.scaling.x = 3.1;
            missingItems.scaling.y = 1;
            missingItems.parent = camera;
            missingItems.position = new BABYLON.Vector3(0, 0.05, 3);
            missingItems.rotation = new BABYLON.Vector3(0, 0, 0);
            missingItems.isVisible = false;
            missingItems.renderingGroupId = 1;


            restart = BABYLON.Mesh.CreatePlane("bar", 0.25, scene, false);
            var restartMat = new BABYLON.StandardMaterial("rBar", scene);
            restartMat.diffuseTexture = new BABYLON.Texture("assets/restart.png", scene);
            restart.material = restartMat;
            restart.scaling.x = 4.5;
            restart.scaling.y = 0.55;
            restart.parent = camera;
            restart.position = new BABYLON.Vector3(1.98, -1.0, 3);
            restart.rotation = new BABYLON.Vector3(0, 0, 0);
            restart.isVisible = false;
            restart.renderingGroupId = 1;

            window.addEventListener("keydown", function (evt) {
                if (evt.keyCode == 27 && pavza) {
                    pavza = false;
                    napis5.isVisible = false;
                    itemFound.isVisible = false;
                    missingItems.isVisible = false;
                } else if (evt.keyCode == 27 && !pavza) {
                    pavza = true;
                    napis5.isVisible = true;
                }
                if (evt.keyCode == 82) {
                    history.go(0);
                }
            }, false);
            window.addEventListener("keydown", function (evt) {
                if (!pavza) {
                    if (evt.keyCode == 65) {//levo
                        if (obrnjenost == 0) {
                            sphere.rotation.y = 7 * (Math.PI / 4);
                            ljudek.rotation.y = 5 * (Math.PI / 4);
                        }
                        else if (obrnjenost == 1) {
                            sphere.rotation.y = 0;
                            ljudek.rotation.y = -Math.PI/2;
                        }
                        else if (obrnjenost == 2) {
                            sphere.rotation.y = Math.PI / 4;
                            ljudek.rotation.y = -Math.PI / 4;
                        }
                        else if (obrnjenost == 3) {
                            sphere.rotation.y = Math.PI / 2;
                            ljudek.rotation.y = 0;
                        }
                        else if (obrnjenost == 4) {
                            sphere.rotation.y = 3 * (Math.PI / 4);
                            ljudek.rotation.y = Math.PI / 4;
                        }
                        else if (obrnjenost == 5) {
                            sphere.rotation.y = Math.PI;
                            ljudek.rotation.y = Math.PI / 2;
                        }
                        else if (obrnjenost == 6) {
                            sphere.rotation.y = 5 * (Math.PI / 4);
                            ljudek.rotation.y = 3 * (Math.PI / 4);

                        }
                        else if (obrnjenost == 7) {
                            sphere.rotation.y = 3 * (Math.PI / 2);
                            ljudek.rotation.y = Math.PI;
                        }
                        obrnjenost--;
                        if (obrnjenost < 0) {
                            obrnjenost = obrnjenost + 8;
                        }
                    }
                    if (evt.keyCode == 68) {//desno
                        if (obrnjenost == 0) {
                            sphere.rotation.y = Math.PI / 4;
                            ljudek.rotation.y = -Math.PI / 4;
                        }
                        else if (obrnjenost == 1) {
                            sphere.rotation.y = Math.PI / 2;
                            ljudek.rotation.y = 0;
                        }
                        else if (obrnjenost == 2) {
                            sphere.rotation.y = 3 * (Math.PI / 4);
                            ljudek.rotation.y = Math.PI / 4;
                        }
                        else if (obrnjenost == 3) {
                            sphere.rotation.y = Math.PI;
                            ljudek.rotation.y = Math.PI / 2;
                        }
                        else if (obrnjenost == 4) {
                            sphere.rotation.y = 5 * (Math.PI / 4);
                            ljudek.rotation.y = 3 * (Math.PI / 4);
                        }
                        else if (obrnjenost == 5) {
                            sphere.rotation.y = 3 * (Math.PI / 2);
                            ljudek.rotation.y = Math.PI;
                        }
                        else if (obrnjenost == 6) {
                            sphere.rotation.y = 7 * (Math.PI / 4);
                            ljudek.rotation.y = 5 * (Math.PI / 4);
                        }
                        else if (obrnjenost == 7) {
                            sphere.rotation.y = 0;
                            ljudek.rotation.y = -Math.PI/2;
                        }
                        obrnjenost++;
                        if (obrnjenost > 7) {
                            obrnjenost = obrnjenost - 8;
                        }
                    }
                    if (evt.keyCode == 83) {//naprej
                        scene.registerBeforeRender(function () {
                            if(!pavza) {
                                hitrost++;
                                sphere.computeWorldMatrix(true);
                                if (!sphere.intersectsMesh(labyrinth, true)) {
                                    var forward = new BABYLON.Vector3(parseFloat(Math.sin(parseFloat(sphere.rotation.y))) / 10, -0.5, parseFloat(Math.cos(parseFloat(sphere.rotation.y))) / 10);
                                    sphere.moveWithCollisions(forward);
                                }
                            }
                        });
                    }
                    if (evt.keyCode == 87) {//nazaj
                        scene.registerBeforeRender(function () {
                            if(!pavza) {
                                hitrost--;
                                sphere.computeWorldMatrix(true);
                                if (!sphere.intersectsMesh(labyrinth, true)) {
                                    var backwards = new BABYLON.Vector3(parseFloat(Math.sin(parseFloat(sphere.rotation.y))) / 10, 0.5, parseFloat(Math.cos(parseFloat(sphere.rotation.y))) / 10);
                                    backwards = backwards.negate();
                                    sphere.moveWithCollisions(backwards);
                                }
                            }
                        });
                    }
                }
            }, false);

            meja1 = BABYLON.Mesh.CreatePlane("meja1", 200, scene);
            meja1.position = new BABYLON.Vector3(-34.697440739293484, -8, -35.73790774292142);
            meja1.computeWorldMatrix(true);

            meja2 = BABYLON.Mesh.CreatePlane("meja2", 200, scene);
            meja2.position = new BABYLON.Vector3(-34.697440739293484, -8, 35.73790774292142);
            meja2.computeWorldMatrix(true);


            meja3 = BABYLON.Mesh.CreatePlane("meja3", 200, scene);
            meja3.position = new BABYLON.Vector3(65.95940911260758, -9, -27.82346783729356);
            meja3.rotation.y = Math.PI/2;
            meja3.computeWorldMatrix(true);

            meja4 = BABYLON.Mesh.CreatePlane("meja4", 200, scene);
            meja4.position = new BABYLON.Vector3(-65, -8, 1.6541122569734954);
            meja4.rotation.y = Math.PI/2;
            meja4.computeWorldMatrix(true);

            meja1.isVisible = false;
            meja2.isVisible = false;
            meja3.isVisible = false;
            meja4.isVisible = false;

            // nadomestna tla
            var ground = BABYLON.Mesh.CreatePlane("ground", 500.0, scene);
            ground.material = new BABYLON.StandardMaterial("groundMat", scene);
            ground.material.diffuseColor = new BABYLON.Color3(0.08, 0.08, 0.08);
            ground.material.backFaceCulling = true;
            ground.position = new BABYLON.Vector3(0, -9.99, 0);
            ground.rotation = new BABYLON.Vector3(Math.PI / 2, 0, 0);
            ground.checkCollisions = true;
            ground.renderingGroupId = 0;

            // ozadje
            scene.clearColor = new BABYLON.Color3(0.5, 0.8, 0.5);
            var skybox = BABYLON.Mesh.CreateBox("skyBox", 100.0, scene);
            var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
            skyboxMaterial.backFaceCulling = false;
            skybox.material = skyboxMaterial;
            skybox.infiniteDistance = true;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("assets/skybox", scene);
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skyboxMaterial.position = new BABYLON.Vector3(0, 0, 0);
            skybox.renderingGroupId = 0;
            var startClosed = BABYLON.Mesh.CreateBox("startClosed", 10, scene);
            startClosed.position = new BABYLON.Vector3(-35, -10, -38.73790774292142);
            startClosed.checkCollisions = true;
            startClosed.isVisible = true;
            //startClosed.isVisible = false;
            var vhod = new BABYLON.StandardMaterial("vhod", scene);
            vhod.diffuseTexture = new BABYLON.Texture("assets/door1.png", scene);
            startClosed.material = vhod;
            startClosed.scaling.y = 1;
            startClosed.scaling.x = 0.9;



            kljuc = BABYLON.Mesh.CreateBox("kljuc", 0.5, scene);
            kljuc.position = new BABYLON.Vector3(37, -11, 11.5);
            kljuc.isVisible = false;
            var kljucTex = new BABYLON.StandardMaterial("kTex", scene);
            kljucTex.diffuseTexture = new BABYLON.Texture("assets/key.png", scene);
            kljuc.material = kljucTex;

            kljuc2 = BABYLON.Mesh.CreateBox("kljuc2", 0.5, scene);
            kljuc2.position = new BABYLON.Vector3(-54, -11, -9);
            kljuc2.isVisible = false;
            var kljucTex1 = new BABYLON.StandardMaterial("kTex1", scene);
            kljucTex1.diffuseTexture = new BABYLON.Texture("assets/key.png", scene);
            kljuc2.material = kljucTex1;

            // ITEMS
            item1 = BABYLON.Mesh.CreateBox("i1", 0.5, scene);
            item1.position = new BABYLON.Vector3(-45.483073024119534, -7.5, -30);
            var item1Tex = new BABYLON.StandardMaterial("i1t", scene);
            item1Tex.diffuseTexture = new BABYLON.Texture("assets/item1.png", scene);
            item1.material = item1Tex;

            item2 = BABYLON.Mesh.CreateBox("i2", 0.5, scene);
            item2.position = new BABYLON.Vector3(41.95940911260758, -7.5, -27.82346783729356);
            var item2Tex = new BABYLON.StandardMaterial("i2t", scene);
            item2Tex.diffuseTexture = new BABYLON.Texture("assets/item2.png", scene);
            item2.material = item2Tex;

            item3 = BABYLON.Mesh.CreateBox("i3", 0.5, scene);
            item3.position = new BABYLON.Vector3(42.836697516092684, -7.5, -6.319501548962687);
            var item3Tex = new BABYLON.StandardMaterial("i3t", scene);
            item3Tex.diffuseTexture = new BABYLON.Texture("assets/item3.png", scene);
            item3.material = item3Tex;

            item4 = BABYLON.Mesh.CreateBox("i4", 0.5, scene);
            item4.position = new BABYLON.Vector3(-44.09810739135112, -7.5, 20.632948101757854);
            var item4Tex = new BABYLON.StandardMaterial("i4t", scene);
            item4Tex.diffuseTexture = new BABYLON.Texture("assets/item4.png", scene);
            item4.material = item4Tex;

            scene.beforeRender = function() {
                if(!pavza) {
                    item1.rotation.x += 0.05;
                    item1.rotation.y += 0.05;

                    item2.rotation.x += 0.05;
                    item2.rotation.y += 0.05;

                    item3.rotation.x += 0.05;
                    item3.rotation.y += 0.05;

                    item4.rotation.x += 0.05;
                    item4.rotation.y += 0.05;

                    trapItem.rotation.z -= 0.05;
                    trapItem.rotation.y -= 0.05;

                    kljuc.rotation.x += 0.05;
                    kljuc.rotation.y += 0.05;

                    kljuc2.rotation.x += 0.05;
                    kljuc2.rotation.y += 0.05;
                }
            };


            var pointToIntersect1 = new BABYLON.Vector3(30, -8, 4);
            var pointToIntersect2 = new BABYLON.Vector3(30, -8, 19);
            var pointToIntersect3 = new BABYLON.Vector3(44, -8, 19);
            var pointToIntersect4 = new BABYLON.Vector3(44, -8, 4);
            var tocka1 = BABYLON.Mesh.CreateBox("t1", 1, scene);
            tocka1.position = pointToIntersect1;
            tocka1.isVisible = false;
            var tocka2 = BABYLON.Mesh.CreateBox("t2", 1, scene);
            tocka2.position = pointToIntersect2;
            tocka2.isVisible = false;
            var tocka3 = BABYLON.Mesh.CreateBox("t3", 1, scene);
            tocka3.position = pointToIntersect3;
            tocka3.isVisible = false;
            var tocka4 = BABYLON.Mesh.CreateBox("t4", 1, scene);
            tocka4.position = pointToIntersect4;
            tocka4.isVisible = false;

            posast = BABYLON.Mesh.CreateBox("p", 1.2, scene);
            posast.position = new BABYLON.Vector3(30, -8, 2);
            posast.isVisible = false;
            var zPlus = true;
            var zMinus = false;
            var xPlus = false;
            var xMinus = false;
            posast.computeWorldMatrix(true);
            tocka2.computeWorldMatrix(true);
            tocka3.computeWorldMatrix(true);
            tocka4.computeWorldMatrix(true);

            var ammoTex = new BABYLON.StandardMaterial("ammoTex", scene);
            ammoTex.diffuseTexture = new BABYLON.Texture("assets/monsterlayer1.bmp", scene);

            scene.registerBeforeRender(function () {
                if (!pavza) {
                    if (posast.intersectsMesh(tocka1, false)) {
                        //if(posast.position.x==31 && posast.position.z==4){
                        zPlus = true;
                        zMinus = false;
                        xPlus = false;
                        xMinus = false;
                    }
                    if (posast.intersectsMesh(tocka2, false)) {
                        //if(posast.position.x==31 && posast.position.z==19){
                        zPlus = false;
                        zMinus = false;
                        xPlus = true;
                        xMinus = false;
                    }
                    if (posast.intersectsMesh(tocka3, false)) {
                        //if(posast.position.x==44 && posast.position.z==19){
                        zPlus = false;
                        zMinus = true;
                        xPlus = false;
                        xMinus = false;
                    }
                    if (posast.intersectsMesh(tocka4, false)) {
                        //if(posast.position.x==44 && posast.position.z==4){
                        zPlus = false;
                        zMinus = false;
                        xPlus = false;
                        xMinus = true;
                    }
                    if (zPlus) {
                        posast.position.z += 0.05;
                    }
                    if (zMinus) {
                        posast.position.z -= 0.05;
                    }
                    if (xPlus) {
                        posast.position.x += 0.05;
                    }
                    if (xMinus) {
                        posast.position.x -= 0.05;
                    }
                }
            });
            var metki = 0;
            setInterval(function () {
                if (posastStrela && !ubita) {
                    var zacX = posast.position.x;
                    var zacY = posast.position.y;
                    var zacZ = posast.position.z;
                    var ammo2 = BABYLON.Mesh.CreateSphere("sphere" + metki, 10, 0.5, scene);
                    ammo2.position = new BABYLON.Vector3(zacX, zacY, zacZ);
                    //ammo2.checkCollisions = true;
                    ammo2.material = ammoTex;
                    ammo2.computeWorldMatrix(true);
                    premikajMetek(scene, ammo2, metki, zPlus, zMinus, xPlus, xMinus, sphere);
                    metki++;
                }
            }, 1000);
            var metki2 = 0;
            var zPlus1 = false;
            var zMinus1 = false;
            var xPlus1 = false;
            var xMinus1 = false;

            var strel = new BABYLON.Sound("Gunshot", "assets/pop1.wav", scene, function () {
                strel.play();
                strel.stop();
            });

            window.addEventListener("keydown", function (evt) {
                if (evt.keyCode == 32 && st==1) {
                    strel.play();
                    // space bar
                    // pridobis koordinate od pozicije igralca
                    var zacX = sphere.position.x;
                    var zacY = sphere.position.y;
                    var zacZ = sphere.position.z;
                    var ammo1 = BABYLON.Mesh.CreateSphere("metki" + metki2, 10, 0.5, scene);
                    var ammoPlayerTex = new BABYLON.StandardMaterial("ammoPlayerTex", scene);
                    ammoPlayerTex.diffuseTexture = new BABYLON.Texture("assets/player5.png", scene);
                    ammo1.material = ammoPlayerTex;
                    if (obrnjenost == 4) {
                        ammo1.position = new BABYLON.Vector3(zacX, zacY, zacZ + 2);
                        zPlus1 = true;
                        xPlus1 = false;
                        xMinus1 = false;
                        zMinus1 = false;
                    }
                    else if (obrnjenost == 5) {
                        ammo1.position = new BABYLON.Vector3(zacX + 2, zacY, zacZ + 2);
                        zPlus1 = true;
                        xPlus1 = true;
                        xMinus1 = false;
                        zMinus1 = false;
                    }
                    else if (obrnjenost == 6) {
                        ammo1.position = new BABYLON.Vector3(zacX + 2, zacY, zacZ);
                        zPlus1 = false;
                        xPlus1 = true;
                        xMinus1 = false;
                        zMinus1 = false;
                    }
                    else if (obrnjenost == 7) {
                        ammo1.position = new BABYLON.Vector3(zacX + 2, zacY, zacZ - 2);
                        zPlus1 = false;
                        xPlus1 = true;
                        xMinus1 = false;
                        zMinus1 = true;
                    }
                    else if (obrnjenost == 0) {
                        ammo1.position = new BABYLON.Vector3(zacX, zacY, zacZ - 2);
                        zPlus1 = false;
                        xPlus1 = false;
                        xMinus1 = false;
                        zMinus1 = true;
                    }
                    else if (obrnjenost == 1) {
                        ammo1.position = new BABYLON.Vector3(zacX - 2, zacY, zacZ - 2);
                        zPlus1 = false;
                        xPlus1 = false;
                        xMinus1 = true;
                        zMinus1 = true;
                    }
                    else if (obrnjenost == 2) {
                        ammo1.position = new BABYLON.Vector3(zacX - 2, zacY, zacZ);
                        zPlus1 = false;
                        xPlus1 = false;
                        xMinus1 = true;
                        zMinus1 = false;
                    }
                    else if (obrnjenost == 3) {
                        ammo1.position = new BABYLON.Vector3(zacX - 2, zacY, zacZ + 2);
                        zPlus1 = true;
                        xPlus1 = false;
                        xMinus1 = true;
                        zMinus1 = false;
                    }
                    //ammo1.checkCollisions = true;
                    ammo1.computeWorldMatrix(true);
                    premikajMetekIgralca(scene, ammo1, metki2, posast, sphere, xPlus1, xMinus1, zPlus1, zMinus1, sefe);
                    metki2++;
                }
                else if (evt.keyCode==32 && st == 0) {
                    napis6.isVisible = false;
                    napis.isVisible = true;
                    napis2.isVisible = true;
                    napis4.isVisible = true;
                    restart.isVisible = true;
                    pavza = false;
                    st = 1;
                    music.play();
                    life1.isVisible = true;
                    life2.isVisible = true;
                    life3.isVisible = true;
                    life4.isVisible = true;
                    life5.isVisible = true;
                }
            }, false);

            izhod = BABYLON.Mesh.CreateBox("izhod", 10, scene);
            izhod.position = new BABYLON.Vector3(-65, -8, 1.6541122569734954);
            izhod.checkCollisions = true;
            var door = new BABYLON.StandardMaterial("door", scene);
            door.diffuseTexture = new BABYLON.Texture("assets/door.png", scene);
            izhod.material = door;
            izhod.scaling.y = 1;
            izhod.scaling.x = 0.8;


            var spriteManager = new BABYLON.SpriteManager("sm", "", 1, 1000, scene);
            spriteManager._spriteTexture = new BABYLON.Texture('assets/monster1.png', scene, true, false);
            spriteManager._spriteTexture.wrapU = BABYLON.Texture.CLAMP_ADDRESSMODE;
            spriteManager._spriteTexture.wrapV = BABYLON.Texture.CLAMP_ADDRESSMODE;
            var monster = new BABYLON.Sprite("textSprite", spriteManager);
            monster.position = new BABYLON.Vector3(-7.085305363401764, -7, -19.6351173389420747);
            monster.size = 10;

            var tockaSefa1 = BABYLON.Mesh.CreateBox("ts1", 6, scene);
            tockaSefa1.position = new BABYLON.Vector3(-58, -8, 2.6541122569734954);
            tockaSefa1.isVisible = false;
            var tockaSefa2 = BABYLON.Mesh.CreateBox("ts2", 6, scene);
            tockaSefa2.position = new BABYLON.Vector3(-58, -8, -16.14588774302654);
            tockaSefa2.isVisible = false;
            sefe = BABYLON.Mesh.CreateBox("sefe", 2.5, scene);
            sefe.isVisible = false;
            sefe.position = new BABYLON.Vector3(-58, -8, -8);
            var zPlusSefe = true;
            tockaSefa1.computeWorldMatrix(true);
            tockaSefa2.computeWorldMatrix(true);
            izhod.computeWorldMatrix(true);
            scene.registerBeforeRender(function () {
                if (!pavza) {
                    if (sefe.intersectsMesh(tockaSefa1, false)) {
                        //if(posast.position.x==31 && posast.position.z==4){
                        zPlusSefe = false;
                    }
                    if (sefe.intersectsMesh(tockaSefa2, false)) {
                        //if(posast.position.x==31 && posast.position.z==19){
                        zPlusSefe = true;
                    }
                    if (zPlusSefe) {
                        sefe.position.z += 0.05;
                    } else {
                        sefe.position.z -= 0.05;
                    }
                }
            });
            var metki3 = 0;
            if (!pavza) {
                setInterval(function () {
                    if (sefeStrela && !sefeUbit) {
                        var zacX = sefe.position.x;
                        var zacY = sefe.position.y;
                        var zacZ = sefe.position.z;
                        var ammo31 = BABYLON.Mesh.CreateSphere("sm" + metki3, 10, 0.5, scene);
                        metki3++;
                        var ammo32 = BABYLON.Mesh.CreateSphere("sm" + metki3, 10, 0.5, scene);
                        metki3++;
                        var ammo33 = BABYLON.Mesh.CreateSphere("sm" + metki3, 10, 0.5, scene);
                        metki3++;
                        ammo31.material = ammoTex;
                        ammo32.material = ammoTex;
                        ammo33.material = ammoTex;
                        ammo31.position = new BABYLON.Vector3(zacX, zacY, zacZ - 1);
                        ammo32.position = new BABYLON.Vector3(zacX, zacY, zacZ);
                        ammo33.position = new BABYLON.Vector3(zacX, zacY, zacZ + 1);
                        //ammo2.checkCollisions = true;
                        ammo31.computeWorldMatrix(true);
                        ammo32.computeWorldMatrix(true);
                        ammo33.computeWorldMatrix(true);
                        premikajMetekSefe(scene, ammo31, ammo32, ammo33, metki3, sphere);
                    }
                }, 1500);
            }
            /*setInterval(function(){
             console.log(sphere.position);
             },3000);*/
            scene.gravity = new BABYLON.Vector3(0, -0.9, 0);
            scene.collisionsEnabled = true;
            camera.checkCollisions = true;
            camera.applyGravity = true;
            sphere.applyGravity = true;
            sphere.checkCollisions = true;
            sphere.ellipsoid = new BABYLON.Vector3(1, 1, 1);
            camera.ellipsoid = new BABYLON.Vector3(1, 1, 1);
            skybox.checkCollisions = true;

            sphere.computeWorldMatrix(true);
            item1.computeWorldMatrix(true);
            item2.computeWorldMatrix(true);
            item3.computeWorldMatrix(true);
            kljuc.computeWorldMatrix(true);
            item4.computeWorldMatrix(true);
            var kljuc2Pobran = false;
            var alertHappened = false;
            var pobranItem1 = false;
            var pobranItem2 = false;
            var pobranItem3 = false;
            var pobranItem4 = false;
            var pobranKljuc1 = false;
            var pobranKljuc2 = false;
            scene.registerBeforeRender(function () {
                if (!pavza) {
                    if (!pobranItem1) {
                        if (sphere.intersectsMesh(item1, true)) {
                            stevecObjektov++;
                            //alert("You found the " + stevecObjektov + "/4 piece of your past! :O");
                            item1.dispose();
                            pobranItem1 = true;
                            itemFound.isVisible = true;
                            pavza=true;
                            //item1 = null;
                            //console.log(stevecObjektov);
                            if (stevecObjektov == 1) {
                                material2.diffuseTexture = new BABYLON.Texture("assets/1.png", scene);
                            } else if (stevecObjektov == 2) {
                                material2.diffuseTexture = new BABYLON.Texture("assets/2.png", scene);
                            } else if (stevecObjektov == 3) {
                                material2.diffuseTexture = new BABYLON.Texture("assets/3.png", scene);
                            } else if (stevecObjektov == 4) {
                                material2.diffuseTexture = new BABYLON.Texture("assets/4.png", scene);
                                if (kljuc2Pobran) {
                                    izhod.isVisible = false;
                                    izhod.checkCollisions = false;
                                }
                            }
                        }
                    }
                    if (!pobranItem2) {
                        if (sphere.intersectsMesh(item2, true)) {
                            stevecObjektov++;
                            //alert("You found the " + stevecObjektov + "/4 piece of your past! :O");
                            item2.dispose();
                            pobranItem2 = true;
                            itemFound.isVisible = true;
                            pavza=true;
                            if (stevecObjektov == 1) {
                                material2.diffuseTexture = new BABYLON.Texture("assets/1.png", scene);
                            } else if (stevecObjektov == 2) {
                                material2.diffuseTexture = new BABYLON.Texture("assets/2.png", scene);
                            } else if (stevecObjektov == 3) {
                                material2.diffuseTexture = new BABYLON.Texture("assets/3.png", scene);
                            } else if (stevecObjektov == 4) {
                                material2.diffuseTexture = new BABYLON.Texture("assets/4.png", scene);
                                if (kljuc2Pobran) {
                                    izhod.isVisible = false;
                                    izhod.checkCollisions = false;
                                }
                            }
                        }
                    }
                    if (!pobranItem3) {
                        if (sphere.intersectsMesh(item3, true)) {
                            stevecObjektov++;
                            //alert("You found the " + stevecObjektov + "/4 piece of your past! :O");
                            item3.dispose();
                            pobranItem3 = true;
                            itemFound.isVisible = true;
                            pavza=true;
                            if (stevecObjektov == 1) {
                                material2.diffuseTexture = new BABYLON.Texture("assets/1.png", scene);
                            } else if (stevecObjektov == 2) {
                                material2.diffuseTexture = new BABYLON.Texture("assets/2.png", scene);
                            } else if (stevecObjektov == 3) {
                                material2.diffuseTexture = new BABYLON.Texture("assets/3.png", scene);
                            } else if (stevecObjektov == 4) {
                                material2.diffuseTexture = new BABYLON.Texture("assets/4.png", scene);
                                if (kljuc2Pobran) {
                                    izhod.isVisible = false;
                                    izhod.checkCollisions = false;
                                }
                            }
                        }
                    }
                    if (!pobranItem4) {
                        if (sphere.intersectsMesh(item4, true)) {
                            stevecObjektov++;
                            //alert("You found the " + stevecObjektov + "/4 piece of your past! :O");
                            item4.dispose();
                            pobranItem4 = true;
                            itemFound.isVisible = true;
                            pavza=true;
                            if (stevecObjektov == 1) {
                                material2.diffuseTexture = new BABYLON.Texture("assets/1.png", scene);
                            } else if (stevecObjektov == 2) {
                                material2.diffuseTexture = new BABYLON.Texture("assets/2.png", scene);
                            } else if (stevecObjektov == 3) {
                                material2.diffuseTexture = new BABYLON.Texture("assets/3.png", scene);
                            } else if (stevecObjektov == 4) {
                                material2.diffuseTexture = new BABYLON.Texture("assets/4.png", scene);
                                if (kljuc2Pobran) {
                                    izhod.isVisible = false;
                                    izhod.checkCollisions = false;
                                }
                            }
                        }
                    }
                    if (!pobranKljuc1) {
                        if (sphere.intersectsMesh(kljuc, true)) {
                            kljuc.dispose()
                            pobranKljuc1 = true;
                            tockaVklopa2.isVisible = false;
                            tockaVklopa2.checkCollisions = false;
                        }
                    }
                    if (!pobranKljuc2) {
                        if (sphere.intersectsMesh(kljuc2, true)) {
                            kljuc2.dispose();
                            pobranKljuc2 = true;
                            kljuc2Pobran = true;
                            if (stevecObjektov == 4) {
                                izhod.isVisible = false;
                                izhod.checkCollisions = false;
                            } else if (!alertHappened) {
                                //alert("To exit, collect all the items!");
                                pavza = true;
                                missingItems.isVisible = true;
                                alertHappened = true;
                            }
                        }
                    }
                    if (sphere.intersectsMesh(izhod, true)) {
                        if (kljuc2Pobran && stevecObjektov == 4) {
                            //alert("You completed this level!");
                            winWin();
                        }
                    }
                }
            });
            //vklop
            /*x: -42.814303215674606
             y: -7.979999847455096
             z: -16.63332821952278
             //izklop
             x: -37.214303215674526
             y: -7.979999618602536
             z: -16.63332821952278
             */
            var tockaVklopaSefe1 = BABYLON.Mesh.CreateBox("tvs1", 5, scene);
            tockaVklopaSefe1.position = new BABYLON.Vector3(-40, -8, -16.63332821952278);
            var tockaIzklopaSefe1 = BABYLON.Mesh.CreateBox("tis1", 5, scene);
            tockaIzklopaSefe1.position = new BABYLON.Vector3(-37.2, -8, -16.63332821952278);
            tockaVklopaSefe1.isVisible = false;
            tockaIzklopaSefe1.isVisible = false;
            tockaVklopaSefe1.computeWorldMatrix(true);
            tockaIzklopaSefe1.computeWorldMatrix(true);
            scene.registerBeforeRender(function () {
                if (!pavza) {
                    if (sphere.intersectsMesh(tockaVklopaSefe1, true)) {
                        sefeStrela = true;
                        if(!sefeUbit){
                            gr.play();
                        }
                        //console.log(posastStrela);
                    }
                    if (sphere.intersectsMesh(tockaIzklopaSefe1, true)) {
                        sefeStrela = false;
                        //console.log(posastStrela);
                    }
                }
            });
            var tockaVklopa1 = BABYLON.Mesh.CreateBox("tv1", 7, scene);
            tockaVklopa1.position = new BABYLON.Vector3(30.07581594828071, -8, -12.182966390649216);
            var tockaIzklopa1 = BABYLON.Mesh.CreateBox("ti1", 5, scene);
            tockaIzklopa1.position = new BABYLON.Vector3(21.275815948280627, -8, -12.182966390649216);
            tockaVklopa2 = BABYLON.Mesh.CreateBox("tv2", 10, scene);
            tockaVklopa2.position = new BABYLON.Vector3(30.6852949892746, -8, 28.087330345619428);
            //var napis = BABYLON.Mesh.CreatePlane("memorybar", 0.25, scene, false);
            var resetke = new BABYLON.StandardMaterial("resetke", scene);
            resetke.diffuseTexture = new BABYLON.Texture("assets/resetke.png", scene);
            tockaVklopa2.material = resetke;
            tockaVklopa2.scaling.y = 1;
            tockaVklopa2.scaling.x = 1;
            //napis.parent = camera;
            //napis.position = new BABYLON.Vector3(1.40, 1.15, 3);
            //napis.rotation = new BABYLON.Vector3(0, 0, 0);
            napis.renderingGroupId = 1;
            var tockaIzklopa2 = BABYLON.Mesh.CreateBox("ti2", 5, scene);
            tockaIzklopa2.position = new BABYLON.Vector3(25.75894939254551, -8, 27.71661966750084);
            var tockaIzklopa3 = BABYLON.Mesh.CreateBox("ti3", 5, scene);
            tockaIzklopa3.position = new BABYLON.Vector3(34.85894939254564, -8, 27.71661966750084);
            var tockaIzklopa4 = BABYLON.Mesh.CreateBox("ti4", 5, scene);
            tockaIzklopa4.position = new BABYLON.Vector3(34.24000363347499, -8, -14.428874815235849);
            tockaVklopa1.isVisible = false;
            //tockaVklopa2.isVisible=false;
            tockaVklopa2.checkCollisions = true;
            tockaIzklopa1.isVisible = false;
            tockaIzklopa2.isVisible = false;
            tockaIzklopa3.isVisible = false;
            tockaIzklopa4.isVisible = false;
            tockaVklopa1.computeWorldMatrix(true);
            tockaVklopa2.computeWorldMatrix(true);
            tockaIzklopa1.computeWorldMatrix(true);
            tockaIzklopa2.computeWorldMatrix(true);
            tockaIzklopa3.computeWorldMatrix(true);
            tockaIzklopa4.computeWorldMatrix(true);
            scene.registerBeforeRender(function () {
                if (!pavza) {
                    if (sphere.intersectsMesh(tockaVklopa1, true)) {
                        posastStrela = true;
                        if(!ubita){
                            gr.play();
                        }
                        //console.log(posastStrela);
                    }
                    if (sphere.intersectsMesh(tockaVklopa2, true)) {
                        posastStrela = true;
                        //console.log(posastStrela);
                    }
                    if (sphere.intersectsMesh(tockaIzklopa1, true)) {
                        posastStrela = false;
                        //console.log(posastStrela);
                    }
                    if (sphere.intersectsMesh(tockaIzklopa2, true)) {
                        posastStrela = false;
                        //console.log(posastStrela);
                    }
                    if (sphere.intersectsMesh(tockaIzklopa3, true)) {
                        posastStrela = false;
                        //console.log(posastStrela);
                    }
                    if (sphere.intersectsMesh(tockaIzklopa4, true)) {
                        posastStrela = false;
                        //console.log(posastStrela);
                    }
                }
            });
            // trap
            trapCoorX = 5.936075381233885;
            trapCoorY = -9;
            trapCoorZ = 29.29639942001256;
            //var trapItem = BABYLON.Mesh.CreateBox("t1", 1, scene);
            trapItem = BABYLON.Mesh.CreateBox("trap1", 1, scene);
            trapItem.rotate.z = Math.PI / 2;
            var trapTex = new BABYLON.StandardMaterial("trapTex", scene);
            trapTex.diffuseTexture = new BABYLON.Texture("assets/trap.png", scene);
            trapItem.material = trapTex;
            trapItem.scaling.y = 1;
            trapItem.scaling.x = 1;

            trapItem.position = new BABYLON.Vector3(trapCoorX, trapCoorY, trapCoorZ);
            scene.registerBeforeRender(function () {
                if (!pavza) {
                    sphere.computeWorldMatrix(true);
                    if (sphere.intersectsMesh(trapItem, false)) {
                        //stevecObjektov++;
                        //alert("It's a trap!");
                        sphere.position = new BABYLON.Vector3(-45.483073024119534, -16, -30);
                        //alert("Congratulations, you've fallen into our trap, GAME OVER");
                        lose();
                    }
                }
            });
            return scene;

        };

        var scene = createScene();

        engine.runRenderLoop(function () {
            //if (!pavza) {
            scene.render();
            //}
        });

        window.addEventListener("resize", function () {
            engine.resize();
        });

    }
    function premikajMetekIgralca(scene, metek, index, posast,sphere,xPlus1,xMinus1,zPlus1,zMinus1, sefe){
        var zadet=false;
        var zivi=true;
        scene.registerBeforeRender(function(){
            if(!pavza) {
                if(!zadet) {
                    if (scene.getMeshByName("metki" + index)) {
                        if (zPlus1 && xPlus1) {
                            metek.position.z += 0.2;
                            metek.position.x += 0.2;
                        }
                        else if (xPlus1 && zMinus1) {
                            metek.position.z -= 0.2;
                            metek.position.x += 0.2;
                        }
                        else if (zMinus1 && xMinus1) {
                            metek.position.z -= 0.2;
                            metek.position.x -= 0.2;
                        }
                        else if (zPlus1 && xMinus1) {
                            metek.position.z += 0.2;
                            metek.position.x -= 0.2;
                        }
                        else if (zPlus1) {
                            metek.position.z += 0.2;
                        }
                        else if (xPlus1) {
                            metek.position.x += 0.2;
                        }
                        else if (zMinus1) {
                            metek.position.z -= 0.2;
                        }
                        else if (xMinus1) {
                            metek.position.x -= 0.2;
                        }
                        if (posast.intersectsMesh(metek, true)) {
                            metek.dispose();
                            stZadetkov--;
                            if (stZadetkov == 0) {
                                //alert("Ubili ste posast! :D");
                                kljuc.position = new BABYLON.Vector3(37, -8, 11.5);
                                kljuc.isVisible = true;
                                gr2.play();
                                posast.dispose();
                                ubita = true;
                            }
                            zadet = true;
                        }
                        if (sefe.intersectsMesh(metek, true)) {
                            metek.dispose();
                            stZadetkovSefe--;
                            if (stZadetkovSefe == 0) {
                                //alert("Ubili ste sefa! :D");
                                gr2.play();
                                sefe.dispose();
                                kljuc2.position =new BABYLON.Vector3(-54, -8, -9);
                                kljuc2.isVisible = true;
                                sefeUbit = true;
                            }
                            zadet = true;
                        }
                        if(metek.intersectsMesh(meja1, true)){
                            metek.dispose();
                            zadet=true;
                            //console.log("Disposed");
                        }
                        if(metek.intersectsMesh(meja2, true)){
                            metek.dispose();
                            zadet=true;
                            //console.log("Disposed");
                        }
                        if(metek.intersectsMesh(meja3, true)){
                            metek.dispose();
                            zadet=true;
                            //console.log("Disposed");
                        }
                        if(metek.intersectsMesh(meja4, true)){
                            metek.dispose();
                            zadet=true;
                            //console.log("Disposed");
                        }
                        var stevec = 0;
                        setInterval(function(){
                            if(stevec > 0){
                                metek.dispose();
                                zadet=true;
                            }else{
                                stevec++;
                            }
                        }, 5000);
                    }
                }
            }
        });
    }
    function premikajMetekSefe(scene, metek1, metek2, metek3, index, sphere){
        var zadet1=false;
        var zadet2=false;
        var zadet3=false;
        scene.registerBeforeRender(function(){
            if(!pavza) {
                if(!zadet1){
                    //if(scene.getMeshByName("sm"+index-3)){
                    metek1.position.z -= 0.2;
                    metek1.position.x += 0.2;
                }
                if(!zadet2){
                    //if(scene.getMeshByName("sm"+index-2)){
                    metek2.position.x += 0.2;
                }
                if(!zadet3){
                    //if(scene.getMeshByName("sm"+index-1)){
                    metek3.position.z += 0.2;
                    metek3.position.x += 0.2;
                }
                if (!zadet1) {
                    if (sphere.intersectsMesh(metek1, true)) {
                        metek1.dispose();
                        if (life1.position.y == 1.15) {
                            life1.position = new BABYLON.Vector3(2.13, 10.15, 3);
                        }
                        else if (life2.position.y == 1.15) {
                            life2.position = new BABYLON.Vector3(2.13, 10.15, 3);
                        }
                        else if (life3.position.y == 1.15) {
                            life3.position = new BABYLON.Vector3(2.13, 10.15, 3);
                        }
                        else if (life4.position.y == 1.15) {
                            life4.position = new BABYLON.Vector3(2.13, 10.15, 3);
                        }
                        else if (life5.position.y == 1.15) {
                            life5.position = new BABYLON.Vector3(2.13, 10.15, 3);
                        }
                        else {
                            lose();
                            //posast.position = start;
                        }
                        zadet1 = true;
                    }
                    if(metek1.intersectsMesh(meja1, true)){
                        metek1.dispose();
                        zadet1=true;
                        //console.log("Disposed");
                    }
                    if(metek1.intersectsMesh(meja2, true)){
                        metek1.dispose();
                        zadet1=true;
                        //console.log("Disposed");
                    }
                    if(metek1.intersectsMesh(meja3, true)){
                        metek1.dispose();
                        zadet1=true;
                        //console.log("Disposed");
                    }
                    if(metek1.intersectsMesh(meja4, true)){
                        metek1.dispose();
                        zadet1=true;
                        //console.log("Disposed");
                    }
                    if(sefeUbit){
                        metek1.dispose();
                        zadet1=true;
                    }
                    var stevec = 0;
                    setInterval(function(){
                        if(stevec > 0){
                            metek1.dispose();
                            zadet1=true;
                        }else{
                            stevec++;
                        }
                    }, 5000);
                }
                if (!zadet2) {
                    if (sphere.intersectsMesh(metek2, true)) {
                        metek2.dispose();
                        if (life1.position.y == 1.15) {
                            life1.position = new BABYLON.Vector3(2.13, 10.15, 3);
                        }
                        else if (life2.position.y == 1.15) {
                            life2.position = new BABYLON.Vector3(2.13, 10.15, 3);
                        }
                        else if (life3.position.y == 1.15) {
                            life3.position = new BABYLON.Vector3(2.13, 10.15, 3);
                        }
                        else if (life4.position.y == 1.15) {
                            life4.position = new BABYLON.Vector3(2.13, 10.15, 3);
                        }
                        else if (life5.position.y == 1.15) {
                            life5.position = new BABYLON.Vector3(2.13, 10.15, 3);
                        }
                        else {
                            lose();
                            //posast.position = start;
                        }
                        zadet2 = true;
                    }
                    if(metek2.intersectsMesh(meja1, true)){
                        metek2.dispose();
                        zadet2=true;
                        //console.log("Disposed");
                    }
                    if(metek2.intersectsMesh(meja2, true)){
                        metek2.dispose();
                        zadet2=true;
                        //console.log("Disposed");
                    }
                    if(metek2.intersectsMesh(meja3, true)){
                        metek2.dispose();
                        zadet2=true;
                        //console.log("Disposed");
                    }
                    if(metek2.intersectsMesh(meja4, true)){
                        metek2.dispose();
                        zadet2=true;
                        //console.log("Disposed");
                    }
                    if(sefeUbit){
                        metek2.dispose();
                        zadet2=true;
                    }
                    var stevec = 0;
                    setInterval(function(){
                        if(stevec > 0){
                            metek2.dispose();
                            zadet2=true;
                        }else{
                            stevec++;
                        }
                    }, 5000);
                }
                if (!zadet3) {
                    if (sphere.intersectsMesh(metek3, true)) {
                        metek3.dispose();
                        if (life1.position.y == 1.15) {
                            life1.position = new BABYLON.Vector3(2.13, 10.15, 3);
                        }
                        else if (life2.position.y == 1.15) {
                            life2.position = new BABYLON.Vector3(2.13, 10.15, 3);
                        }
                        else if (life3.position.y == 1.15) {
                            life3.position = new BABYLON.Vector3(2.13, 10.15, 3);
                        }
                        else if (life4.position.y == 1.15) {
                            life4.position = new BABYLON.Vector3(2.13, 10.15, 3);
                        }
                        else if (life5.position.y == 1.15) {
                            life5.position = new BABYLON.Vector3(2.13, 10.15, 3);
                        }
                        else {
                            lose();
                            //posast.position = start;
                        }
                        zadet3 = true;
                    }
                    if(metek3.intersectsMesh(meja1, true)){
                        metek3.dispose();
                        zadet3=true;
                        //console.log("Disposed");
                    }
                    if(metek3.intersectsMesh(meja2, true)){
                        metek3.dispose();
                        zadet3=true;
                        //console.log("Disposed");
                    }
                    if(metek3.intersectsMesh(meja3, true)){
                        metek3.dispose();
                        zadet3=true;
                        //console.log("Disposed");
                    }
                    if(metek3.intersectsMesh(meja4, true)){
                        metek3.dispose();
                        zadet3=true;
                        //console.log("Disposed");
                    }
                    if(sefeUbit){
                        metek3.dispose();
                        zadet3=true;
                    }
                    var stevec = 0;
                    setInterval(function(){
                        if(stevec > 0){
                            metek3.dispose();
                            zadet3=true;
                        }else{
                            stevec++;
                        }
                    }, 5000);
                }
            }
        });
    }
    function premikajMetek(scene, metek, index, zPlus, zMinus, xPlus, xMinus, sphere){
        var zadet=false;
        scene.registerBeforeRender(function(){
            if(!pavza) {
                if (!zadet) {
                    if (scene.getMeshByName("sphere" + index)) {
                        if (zPlus) {
                            metek.position.z -= 0.2;
                        }
                        if (zMinus) {
                            metek.position.x -= 0.2;
                        }
                        if (xPlus) {
                            metek.position.x -= 0.2;
                            metek.position.z -= 0.2;
                        }
                        if (xMinus) {
                            metek.position.x -= 0.2;
                            metek.position.z += 0.2
                        }
                        if (sphere.intersectsMesh(metek, true)) {
                            metek.dispose();
                            if (life1.position.y == 1.15) {
                                life1.position = new BABYLON.Vector3(2.13, 10.15, 3);
                            }
                            else if (life2.position.y == 1.15) {
                                life2.position = new BABYLON.Vector3(2.13, 10.15, 3);
                            }
                            else if (life3.position.y == 1.15) {
                                life3.position = new BABYLON.Vector3(2.13, 10.15, 3);
                            }
                            else if (life4.position.y == 1.15) {
                                life4.position = new BABYLON.Vector3(2.13, 10.15, 3);
                            }
                            else if (life5.position.y == 1.15) {
                                life5.position = new BABYLON.Vector3(2.13, 10.15, 3);
                            }
                            else {
                                lose();
                                //posast.position = start;
                            }
                            zadet = true;
                        }
                        if(metek.intersectsMesh(meja1, true)){
                            metek.dispose();
                            zadet=true;
                            //console.log("Disposed");
                        }
                        if(metek.intersectsMesh(meja2, true)){
                            metek.dispose();
                            zadet=true;
                            //console.log("Disposed");
                        }
                        if(metek.intersectsMesh(meja3, true)){
                            metek.dispose();
                            zadet=true;
                            //console.log("Disposed");
                        }
                        if(metek.intersectsMesh(meja4, true)){
                            metek.dispose();
                            zadet=true;
                            //console.log("Disposed");
                        }
                        if(ubita){
                            metek.dispose();
                            zadet=true;
                        }
                        var stevec = 0;
                        setInterval(function(){
                            if(stevec > 0){
                                metek.dispose();
                                zadet=true;
                            }else{
                                stevec++;
                            }
                        }, 5000);
                    }
                }
            }
        });
    }
    function lose() {
        music.stop();
        over.play();
        napis3.isVisible = true;
        window.addEventListener("keydown", function(evt) {
            if(evt.keyCode == 32) {
                history.go(0);
            }
        },false);
    }
    function winWin() {
        music.stop();
        win.play();
        pavza = true;
        restart.isVisible = false;
        napis7.isVisible = true;
        napis6.isVisible = false;
        napis.isVisible = false;
        napis2.isVisible = false;
        napis4.isVisible = false;
        napis3.isVisible = false;
        napis5.isVisible = false;
        life1.isVisible = false;
        life2.isVisible = false;
        life3.isVisible = false;
        life4.isVisible = false;
        life5.isVisible = false;
        window.addEventListener("keydown", function(evt) {
            if(evt.keyCode == 32) {
                history.go(0);
            }
        }, false);
    }

</script>

</body>
</html>